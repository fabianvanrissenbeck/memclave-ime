/**
 * test making sure that subkernel crypto functionality works
 */

#include "aead.h"
#include "ime.h"

#include <string.h>
#include <assert.h>

uint32_t key[8] = { 0x77b07d50, 0x740a81ac, 0xa78fcb5b, 0x74dbbe6a, 0x9aabb9d8, 0xedd28e42, 0xee673b8a, 0x589c2063 };
uint32_t iv[3] = { 0x765ce0f6, 0x213c6cae, 0x6b290646 };

uint32_t tag[4];
uint32_t target_tag[4] = { 0x880f11f4, 0x3fb42706, 0x06d91677, 0xcf90a314 };

__attribute__((aligned(8))) uint32_t buf[128] = {
    0xd6a3fa7c, 0x968f2a09, 0xca412f52, 0x7455bcd3, 0x5d6ae523, 0x57f7dd02, 0x29c0f00b, 0x0e5cdc81,
    0x81b0246d, 0x8a2bde70, 0xe939b6e2, 0xae1fe967, 0xb1c3ae83, 0x0d266115, 0x8aa95f3d, 0x6423ad9f,
    0x300d7b04, 0x9fbc5950, 0x0f64a22e, 0xce4c046b, 0x288070fd, 0xc819ab9d, 0x49435d80, 0xc36ad0cf,
    0x9af1788f, 0xd852a5c7, 0xa7d02532, 0xb18ed38f, 0x8fbc71d5, 0xd8da605d, 0xe20c4239, 0x9b80c680,
    0xd9affd6c, 0xac0b6d8e, 0xb8005d3e, 0xa107e21e, 0x705a485d, 0xfed26f03, 0x57d37a76, 0x955d9f1f,
    0x7eddefaa, 0x868d4ce0, 0x8de83708, 0xf3d9f3fb, 0x0d00fdd4, 0x91e22f2a, 0x1b5c9461, 0xeec96698,
    0xd1fc0fd9, 0xaca86a7c, 0xc281b9cb, 0x3d6803dd, 0x56ba9da9, 0x14b5dea8, 0x59706e65, 0x421d2edd,
    0x105499a8, 0x9722e09d, 0xe3a9478a, 0xc9107311, 0xacf4e85e, 0x719860fe, 0x9a7f72ff, 0xa3908ccd,
    0x4c2d9a3d, 0xfa8f40f0, 0xce853a69, 0x2f4669a0, 0x8d6ed7b0, 0x25dcfaa4, 0xa1e25702, 0x9780472b,
    0x67b9a9a9, 0xaa69cbf5, 0x4d3bc7b1, 0x04bd294b, 0x5ed69561, 0x075da280, 0xbdfd8c96, 0x97474f0a,
    0x35e33e72, 0x0354ea16, 0xf104393b, 0x15d6a935, 0x7db9b74e, 0xaab02422, 0xe63a8226, 0x8e26b46b,
    0xfab3e3e1, 0xbcaffd01, 0x3706e15a, 0x04456f58, 0x3af550cf, 0x7e489e62, 0x52047a4e, 0xae749e96,
    0x5af4b96b, 0xd1a0f764, 0xc0159902, 0x16e4695f, 0x5c8f7283, 0x132bf0d1, 0x9050198b, 0x24f1fd3f,
    0xe070652e, 0xcba1b59e, 0x25a83bf6, 0x923d9dbf, 0x1652dd10, 0xfb5cb270, 0xd730001b, 0x9103dddf,
    0x03f7f00a, 0xad1dc70f, 0xac9b1dd1, 0x1442fa20, 0x1159f45d, 0x9f8a8448, 0xb348bcf6, 0xd9963624,
    0x66808b6b, 0x21daf620, 0x3945a637, 0x8b40b7fe, 0x580c35ef, 0xafa42fe5, 0x3be35716, 0x0b3c7253
};

uint32_t __mram buf_mram[128];

int main(void) {
    mram_write(buf, &buf_mram[0], sizeof(buf));

    ime_aead_enc(key, iv, sizeof(buf), buf, buf, tag, iv);
    assert(memcmp(tag, target_tag, sizeof(target_tag)) == 0);
    assert(ime_aead_dec(key, iv, tag, sizeof(buf), buf, buf));

    ime_aead_enc_mram(key, iv, sizeof(buf_mram), buf_mram, buf_mram, tag, iv);
    assert(memcmp(tag, target_tag, sizeof(target_tag)) == 0);
    assert(ime_aead_dec_mram(key, iv, tag, sizeof(buf_mram), buf_mram, buf_mram));

    for (int i = 0; i < 4; ++i) {
        __ime_debug_out[i] = buf_mram[i];
        __ime_debug_out[i + 4] = tag[i];

        if (i < 3) {
            __ime_debug_out[i + 8] = iv[i];
        }
    }

    asm("stop");
}